(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2183],{63:(e,a,t)=>{"use strict";var s=t(7260);t.o(s,"useParams")&&t.d(a,{useParams:function(){return s.useParams}}),t.o(s,"usePathname")&&t.d(a,{usePathname:function(){return s.usePathname}}),t.o(s,"useRouter")&&t.d(a,{useRouter:function(){return s.useRouter}}),t.o(s,"useSearchParams")&&t.d(a,{useSearchParams:function(){return s.useSearchParams}})},482:(e,a,t)=>{"use strict";t.r(a),t.d(a,{default:()=>o});var s=t(5155),r=t(63),i=t(1026),n=t(2115);let l=async e=>{let a=await fetch(e);if(!a.ok)return null;let t=await a.text();if(!t)return null;try{return JSON.parse(t)}catch(e){return null}};function o(){let e=(0,r.useParams)(),a=null==e?void 0:e.id,{data:t,mutate:o}=(0,i.Ay)(a?"/api/proyectos/".concat(a):null,l),[c,d]=(0,n.useState)(!1),[m,u]=(0,n.useState)({fecha:new Date().toISOString().split("T")[0],notas:"",fotos:[],fotoTitulos:[],guardarEnEvidencia:[]}),[h,x]=(0,n.useState)(!1),f=(null==t?void 0:t.bitacora)||[];async function v(e){let a=[];for(let s=0;s<e.length;s++){var t;let r=e[s],i=new FormData;i.append("files",r);let n=await fetch("/api/uploads",{method:"POST",body:i});if(!n.ok)throw Error("Error subiendo archivo ".concat(r.name));let l=await n.json();a.push({mediaId:l.fileIds[0],thumbId:null==(t=l.thumbIds)?void 0:t[0],titulo:m.fotoTitulos[s]||r.name,enEvidencia:m.guardarEnEvidencia[s]||!1})}return a}async function p(){if(!m.notas.trim())return void alert("Por favor agrega notas para la entrada de bit\xe1cora");x(!0);try{let e=[];m.fotos.length>0&&(e=await v(m.fotos));let t={fecha:m.fecha,notas:m.notas.trim(),fotos:e.map(e=>({...e,enEvidencia:!!e.enEvidencia})),createdBy:void 0,createdAt:new Date().toISOString()},s={bitacora:[...f,t]},r=e.filter(e=>e.enEvidencia);r.length>0&&(s.addEvidencias=r.map(e=>({mediaId:e.mediaId,thumbId:e.thumbId,titulo:e.titulo,puntos:["Agregado desde bit\xe1cora - ".concat(m.fecha)]})));let i=await fetch("/api/proyectos/".concat(a),{method:"PATCH",headers:{"content-type":"application/json"},body:JSON.stringify(s)});if(!i.ok)throw Error(await i.text());await o(),u({fecha:new Date().toISOString().split("T")[0],notas:"",fotos:[],fotoTitulos:[],guardarEnEvidencia:[]}),d(!1),alert("Entrada de bit\xe1cora agregada exitosamente")}catch(e){alert("Error agregando entrada: ".concat((null==e?void 0:e.message)||e))}finally{x(!1)}}return t?(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"text-xl font-semibold",children:"Bit\xe1cora del proyecto"}),(0,s.jsx)("p",{className:"text-sm text-[color:var(--muted)] mt-1",children:"Registro diario de actividades y observaciones"})]}),(0,s.jsx)("button",{onClick:()=>d(!0),className:"btn btn-primary",children:"➕ Nueva entrada"})]}),(0,s.jsxs)("div",{className:"space-y-4",children:[f.sort((e,a)=>new Date(a.fecha).getTime()-new Date(e.fecha).getTime()).map(e=>(0,s.jsxs)("div",{className:"card p-6",children:[(0,s.jsx)("div",{className:"flex items-start justify-between mb-4",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-semibold",children:new Date(e.fecha).toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}),(0,s.jsxs)("p",{className:"text-sm text-[color:var(--muted)]",children:["Por ",e.createdBy," • ",new Date(e.createdAt).toLocaleString("es-ES")]})]})}),(0,s.jsx)("div",{className:"mb-4",children:(0,s.jsx)("p",{className:"whitespace-pre-wrap",children:e.notas})}),e.fotos&&e.fotos.length>0&&(0,s.jsxs)("div",{children:[(0,s.jsxs)("h4",{className:"font-medium mb-3",children:["Fotos (",e.fotos.length,")"]}),(0,s.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:e.fotos.map((e,a)=>(0,s.jsxs)("div",{className:"relative group",children:[(0,s.jsx)("img",{src:"/api/images/".concat(e.thumbId||e.mediaId),alt:e.titulo||"Foto ".concat(a+1),className:"w-full h-32 object-cover rounded-lg"}),(0,s.jsx)("div",{className:"absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-white text-center text-sm p-2",children:[(0,s.jsx)("div",{className:"font-medium",children:e.titulo}),e.enEvidencia&&(0,s.jsx)("div",{className:"text-xs text-green-300 mt-1",children:"✓ En evidencias"})]})})]},a))})]})]},e._id)),0===f.length&&(0,s.jsxs)("div",{className:"text-center py-12 text-[color:var(--muted)]",children:[(0,s.jsx)("span",{className:"text-6xl",children:"\uD83D\uDCDD"}),(0,s.jsx)("div",{className:"text-lg mt-4",children:"No hay entradas en la bit\xe1cora"}),(0,s.jsx)("div",{className:"text-sm mt-2",children:"Agrega la primera entrada para comenzar el registro"})]})]}),c&&(0,s.jsx)("div",{className:"fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col",children:[(0,s.jsxs)("div",{className:"p-6 border-b",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold",children:"Nueva entrada de bit\xe1cora"}),(0,s.jsx)("p",{className:"text-sm text-[color:var(--muted)] mt-1",children:"Registra las actividades y observaciones del d\xeda"})]}),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Fecha *"}),(0,s.jsx)("input",{type:"date",value:m.fecha,onChange:e=>u(a=>({...a,fecha:e.target.value})),className:"w-full input"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Notas y observaciones *"}),(0,s.jsx)("textarea",{value:m.notas,onChange:e=>u(a=>({...a,notas:e.target.value})),className:"w-full input h-32 resize-none",placeholder:"Describe las actividades realizadas, observaciones, problemas encontrados, etc..."})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Fotos"}),m.fotos.length>0&&(0,s.jsx)("div",{className:"space-y-3 mb-4",children:m.fotos.map((e,a)=>(0,s.jsx)("div",{className:"border border-gray-200 rounded-lg p-4",children:(0,s.jsxs)("div",{className:"flex items-start gap-3",children:[(0,s.jsx)("img",{src:URL.createObjectURL(e),alt:e.name,className:"w-20 h-20 object-cover rounded"}),(0,s.jsxs)("div",{className:"flex-1 space-y-2",children:[(0,s.jsx)("input",{type:"text",value:m.fotoTitulos[a],onChange:e=>{var t;return t=e.target.value,void u(e=>({...e,fotoTitulos:e.fotoTitulos.map((e,s)=>s===a?t:e)}))},className:"w-full input",placeholder:"T\xedtulo de la foto (opcional)"}),(0,s.jsxs)("label",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{type:"checkbox",checked:m.guardarEnEvidencia[a],onChange:e=>{var t;return t=e.target.checked,void u(e=>({...e,guardarEnEvidencia:e.guardarEnEvidencia.map((e,s)=>s===a?t:e)}))},className:"w-4 h-4"}),(0,s.jsx)("span",{className:"text-sm",children:"Guardar tambi\xe9n en evidencias"})]})]}),(0,s.jsx)("button",{onClick:()=>{u(e=>({...e,fotos:e.fotos.filter((e,t)=>t!==a),fotoTitulos:e.fotoTitulos.filter((e,t)=>t!==a),guardarEnEvidencia:e.guardarEnEvidencia.filter((e,t)=>t!==a)}))},className:"text-red-600 hover:text-red-800",children:"✕"})]})},a))}),(0,s.jsx)("input",{type:"file",accept:"image/*",multiple:!0,onChange:e=>{Array.from(e.target.files||[]).forEach(e=>{u(a=>({...a,fotos:[...a.fotos,e],fotoTitulos:[...a.fotoTitulos,""],guardarEnEvidencia:[...a.guardarEnEvidencia,!1]}))}),e.target.value=""},className:"w-full input"}),(0,s.jsx)("p",{className:"text-xs text-[color:var(--muted)] mt-1",children:"Puedes seleccionar m\xfaltiples fotos. Formatos soportados: JPG, PNG, GIF"})]})]}),(0,s.jsxs)("div",{className:"p-6 border-t flex gap-3 justify-end",children:[(0,s.jsx)("button",{onClick:()=>{d(!1),u({fecha:new Date().toISOString().split("T")[0],notas:"",fotos:[],fotoTitulos:[],guardarEnEvidencia:[]})},className:"btn btn-ghost",disabled:h,children:"Cancelar"}),(0,s.jsx)("button",{onClick:p,className:"btn btn-primary",disabled:!m.notas.trim()||h,children:h?"Guardando...":"Guardar entrada"})]})]})})]}):(0,s.jsx)("div",{className:"flex items-center justify-center py-12",children:(0,s.jsx)("div",{className:"text-center",children:(0,s.jsx)("div",{className:"text-lg font-medium",children:"Cargando bit\xe1cora..."})})})}},1096:(e,a,t)=>{Promise.resolve().then(t.bind(t,482))}},e=>{e.O(0,[1026,8441,1255,7358],()=>e(e.s=1096)),_N_E=e.O()}]);